==============================
DOCUMENTACI√ìN DE CAMBIOS EN FACTURACI√ìN Y ESQUEMA PRISMA
==============================

1. CAMBIOS EN EL ESQUEMA PRISMA
------------------------------
- Se a√±adi√≥ la relaci√≥n entre `expenses` y `provider_invoices`:
  ‚Ä¢ Campo: provider_invoice_id Int?
  ‚Ä¢ Relaci√≥n: provider_invoice provider_invoices? @relation(fields: [provider_invoice_id], references: [id], onDelete: Cascade)

  ‚û°Ô∏è Raz√≥n: Antes los gastos eran registros aislados. Ahora cada gasto puede estar asociado directamente a una factura de proveedor, lo que mejora la trazabilidad y permite auditar qu√© gasto corresponde a qu√© factura.

- Se a√±adi√≥ la relaci√≥n inversa en `provider_invoices`:
  ‚Ä¢ Campo: expenses expenses[]

  ‚û°Ô∏è Raz√≥n: Permite que las facturas conozcan sus gastos asociados. Sin esta relaci√≥n, solo el gasto sabr√≠a la factura, pero la factura no podr√≠a listar sus gastos. Esto habilita consultas completas (factura + gastos).

- Se a√±adi√≥ la tabla `purchase_invoices_retentions` para vincular retenciones con compras:
  ‚Ä¢ Campos: purchase_invoice_id, retention_code, base_amount, rate_retention, total_retention
  ‚Ä¢ Relaciones: con `purchase_invoices` y `retentions`

  ‚û°Ô∏è Raz√≥n: Antes las retenciones exist√≠an pero no hab√≠a forma de vincularlas a una compra espec√≠fica. Con esta tabla relacional se pueden aplicar m√∫ltiples retenciones a una misma compra (ejemplo: ISLR 6% + IVSS 2%). Cada retenci√≥n queda registrada con c√≥digo, nombre, base imponible, porcentaje y total retenido.

- Se a√±adi√≥ la relaci√≥n `expense_type` en `expenses`:
  ‚Ä¢ Campo: id_expense_type Int
  ‚Ä¢ Relaci√≥n: expense_type expense_types @relation(fields: [id_expense_type], references: [id])

  ‚û°Ô∏è Raz√≥n: Los gastos no ten√≠an clasificaci√≥n clara. Ahora cada gasto se vincula a un tipo definido en el cat√°logo `expense_types` (ejemplo: servicios, suministros, n√≥mina). Esto permite reportes por categor√≠a y an√°lisis m√°s estructurado.

2. M√ìDULOS A√ëADIDOS: ExpenseTypes y Retentions
---------------------------------------------
- `expense_types`: Define los tipos de gastos.
  ‚Ä¢ Campos: id, name, description
  ‚Ä¢ Endpoints: CRUD completo (/api/expense-types)

- `retentions`: Define los tipos de retenci√≥n fiscales.
  ‚Ä¢ Campos: code, name, description
  ‚Ä¢ Endpoints: CRUD completo (/api/retentions)

- `purchase_invoices_retentions`: Tabla relacional entre compras y retenciones.
  ‚Ä¢ Permite definir m√∫ltiples retenciones por compra con sus tasas y montos base.

3. IMPACTO EN LA L√ìGICA DE FACTURACI√ìN
--------------------------------------
- Al registrar una factura de proveedor:
  1. Se crea la factura (`provider_invoices`)
  2. Se crea el detalle de compra (`purchase_invoices`)
  3. Se insertan las retenciones (`purchase_invoices_retentions`)
  4. Se calcula el total neto (monto total - retenciones)
  5. Se crea un gasto autom√°tico (`expenses`) con:
     ‚Ä¢ tipo de gasto (`id_expense_type`)
     ‚Ä¢ descripci√≥n generada autom√°ticamente (ejemplo: "Compra al proveedor X el YYYY-MM-DD")
     ‚Ä¢ total neto
     ‚Ä¢ v√≠nculo directo con la factura (`provider_invoice_id`)
  6. Se actualiza el balance del proveedor

‚û°Ô∏è Raz√≥n: Esto automatiza el flujo fiscal completo y asegura que cada compra se refleje en la tabla de gastos con retenciones aplicadas previamente.

4. ENDPOINTS DISPONIBLES
------------------------
==============================
ORDEN DE PRUEBAS DE ENDPOINTS (PRIMERA VEZ)
==============================

1. CREAR CAT√ÅLOGO DE TIPOS DE GASTO
-----------------------------------
Primero definimos los tipos de gasto que se usar√°n en las compras.

POST http://localhost:3000/api/trans/services/expense-types
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>

Body:
{
  "name": "Suministros",
  "description": "Material de oficina"
}

üëâ Esto crea un tipo de gasto con ID que luego se usar√° en las facturas.

---

2. CREAR CAT√ÅLOGO DE RETENCIONES
--------------------------------
Luego definimos las retenciones fiscales que se aplicar√°n a las compras.

POST http://localhost:3000/api/trans/services/retentions
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>

Body:
{
  "code": "ISLR",
  "name": "Impuesto sobre la renta",
  "description": "Retenci√≥n fiscal ISLR"
}

üëâ Esto crea la retenci√≥n con c√≥digo √∫nico (ejemplo: ISLR).

---

3. CREAR UNA FACTURA DE PROVEEDOR CON COMPRA, RETENCIONES Y GASTO AUTOM√ÅTICO
----------------------------------------------------------------------------
Ahora registramos la primera factura, vinculando compra, retenciones y gasto autom√°tico.

POST http://localhost:3000/api/trans/services/provider-invoice/1
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>

Body:
{
  "control_number": "CN-001",
  "invoice_number": "INV-001",
  "invoice_date": "2025-11-25",
  "total_amount": 1000,
  "purchase": {
    "expense_type_id": 1,
    "purchase_date": "2025-11-25",
    "description": "Compra de suministros",
    "exempt_amount": 0
  },
  "retentions": [
    {
      "retention_code": "ISLR",
      "rate_retention": 6,
      "base_amount": 1000
    }
  ]
}

üëâ Esto genera autom√°ticamente:
   ‚Ä¢ La factura
   ‚Ä¢ La compra vinculada
   ‚Ä¢ Las retenciones aplicadas
   ‚Ä¢ El gasto autom√°tico con descripci√≥n y total neto

---

4. LISTAR TODAS LAS FACTURAS ACTIVAS
------------------------------------
GET http://localhost:3000/api/trans/services/provider-invoices
Headers:
  Authorization: Bearer <TOKEN>

üëâ Verificamos que la factura creada aparece en la lista.

---

5. LISTAR FACTURAS DE UN PROVEEDOR
----------------------------------
GET http://localhost:3000/api/trans/services/provider-invoices/provider/1
Headers:
  Authorization: Bearer <TOKEN>

üëâ Filtramos facturas por proveedor espec√≠fico.

---

6. FILTRAR FACTURAS POR RANGO DE FECHAS
---------------------------------------
GET http://localhost:3000/api/trans/services/provider-invoices-range?start=2025-01-01&end=2025-12-31
Headers:
  Authorization: Bearer <TOKEN>

üëâ Obtenemos facturas emitidas dentro del rango de fechas.

---

7. BUSCAR FACTURA POR N√öMERO FISCAL O CONTROL
---------------------------------------------
GET http://localhost:3000/api/trans/services/provider-invoices/search/CN-001
Headers:
  Authorization: Bearer <TOKEN>

üëâ Localizamos la factura por su n√∫mero de control.

---

8. CONSULTAR RETENCIONES DE UNA COMPRA
--------------------------------------
GET http://localhost:3000/api/trans/services/purchase-invoice/1/retentions
Headers:
  Authorization: Bearer <TOKEN>

üëâ Verificamos las retenciones aplicadas a la compra vinculada.

---

9. CONSULTAR FACTURA COMPLETA (COMPRAS + RETENCIONES + GASTO)
-------------------------------------------------------------
GET http://localhost:3000/api/trans/services/provider-invoices/1/full
Headers:
  Authorization: Bearer <TOKEN>

üëâ Obtenemos la factura con todos sus detalles integrados.

---

10. ELIMINAR L√ìGICAMENTE UNA FACTURA (SOFT DELETE)
--------------------------------------------------
DELETE http://localhost:3000/api/trans/services/provider-invoice/1
Headers:
  Authorization: Bearer <TOKEN>

üëâ Marcamos la factura como eliminada.

---

11. LISTAR FACTURAS ELIMINADAS
------------------------------
GET http://localhost:3000/api/trans/services/provider-invoices-deleted
Headers:
  Authorization: Bearer <TOKEN>

üëâ Verificamos que la factura eliminada aparece en la lista de eliminadas.

---

12. RESTAURAR FACTURA ELIMINADA
-------------------------------
PUT http://localhost:3000/api/trans/services/provider-invoice/restore/1
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>

Body:
{
  "control_number": "CN-RESTORE-001"
}

üëâ Restauramos la factura eliminada con un nuevo n√∫mero de control.

---

==============================
FIN DE LA CREACI√ìN
==============================


==============================
ENDPOINTS DISPONIBLES - FACTURACI√ìN
==============================

FACTURAS DE PROVEEDOR
---------------------
POST    http://localhost:3000/api/trans/services/provider-invoice/:provider_id
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>
Body:
{
  "control_number": "CN-001",
  "invoice_number": "INV-001",
  "invoice_date": "2025-11-25",
  "total_amount": 1000,
  "purchase": {
    "expense_type_id": 1,
    "purchase_date": "2025-11-25",
    "description": "Compra de suministros",
    "exempt_amount": 0
  },
  "retentions": [
    {
      "retention_code": "ISLR",
      "rate_retention": 6,
      "base_amount": 1000
    }
  ]
}

GET     http://localhost:3000/api/trans/services/provider-invoices
Headers:
  Authorization: Bearer <TOKEN>

GET     http://localhost:3000/api/trans/services/provider-invoices/provider/:provider_id
Headers:
  Authorization: Bearer <TOKEN>

GET     http://localhost:3000/api/trans/services/provider-invoices-range?start=YYYY-MM-DD&end=YYYY-MM-DD
Headers:
  Authorization: Bearer <TOKEN>

GET     http://localhost:3000/api/trans/services/provider-invoices/search/:value
Headers:
  Authorization: Bearer <TOKEN>

GET     http://localhost:3000/api/trans/services/provider-invoices-deleted
Headers:
  Authorization: Bearer <TOKEN>

PUT     http://localhost:3000/api/trans/services/provider-invoice/restore/:id
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>
Body:
{
  "control_number": "CN-RESTORE-001"
}

DELETE  http://localhost:3000/api/trans/services/provider-invoice/:id
Headers:
  Authorization: Bearer <TOKEN>

GET     http://localhost:3000/api/trans/services/purchase-invoice/:purchase_invoice_id/retentions
Headers:
  Authorization: Bearer <TOKEN>

GET     http://localhost:3000/api/trans/services/provider-invoices/:id/full
Headers:
  Authorization: Bearer <TOKEN>


TIPOS DE GASTO
--------------
POST    http://localhost:3000/api/trans/services/expense-types
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>
Body:
{
  "name": "Suministros",
  "description": "Material de oficina"
}

GET     http://localhost:3000/api/trans/services/expense-types
Headers:
  Authorization: Bearer <TOKEN>

GET     http://localhost:3000/api/trans/services/expense-types/:id
Headers:
  Authorization: Bearer <TOKEN>

PUT     http://localhost:3000/api/trans/services/expense-types/:id
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>
Body:
{
  "name": "Servicios",
  "description": "Servicios generales"
}

DELETE  http://localhost:3000/api/trans/services/expense-types/:id
Headers:
  Authorization: Bearer <TOKEN>


RETENCIONES
-----------
POST    http://localhost:3000/api/trans/services/retentions
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>
Body:
{
  "code": "ISLR",
  "name": "Impuesto sobre la renta",
  "description": "Retenci√≥n fiscal ISLR"
}

GET     http://localhost:3000/api/trans/services/retentions
Headers:
  Authorization: Bearer <TOKEN>

GET     http://localhost:3000/api/trans/services/retentions/:code
Headers:
  Authorization: Bearer <TOKEN>

PUT     http://localhost:3000/api/trans/services/:code
Headers:
  Content-Type: application/json
  Authorization: Bearer <TOKEN>
Body:
{
  "name": "Impuesto sobre la renta actualizado",
  "description": "Retenci√≥n fiscal ISLR modificada"
}

DELETE  http://localhost:3000/api/trans/services/retentions/:code
Headers:
  Authorization: Bearer <TOKEN>

==============================
FIN DEL DOCUMENTO
==============================


5. CUMPLIMIENTO DEL ENUNCIADO
-----------------------------
‚úî Cuando se realiza una compra:
   - Se registra la factura del proveedor
   - Se registra el detalle de compra
   - Se aplican retenciones usando la tabla `retentions`
   - Se calcula el total neto (monto - retenciones)
   - Se crea un gasto autom√°tico en `expenses` con:
     ‚Ä¢ tipo de gasto
     ‚Ä¢ descripci√≥n generada autom√°ticamente
     ‚Ä¢ total neto
     ‚Ä¢ v√≠nculo con la factura
   - Se actualiza el balance del proveedor

‚úî Las retenciones se almacenan en `purchase_invoices_retentions` con:
   - c√≥digo de retenci√≥n
   - nombre (v√≠a relaci√≥n con `retentions`)
   - tasa aplicada
   - base imponible
   - total retenido

‚úî Todo el proceso ocurre dentro de una transacci√≥n Prisma para garantizar consistencia.

==============================
FIN DEL DOCUMENTO
==============================
