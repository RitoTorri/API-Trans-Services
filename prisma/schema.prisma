generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tabla de usuarios
model users {
  id         Int      @id @default(autoincrement())
  rol        String   @db.VarChar(30)
  username   String   @db.VarChar(30)
  password   String   @db.VarChar(60)
  created_at DateTime @default(now()) @map("created_at")

  @@map("users")
}

// Todo de empleados
model employees {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(40)
  lastname   String   @db.VarChar(40)
  ci         String   @unique @db.VarChar(13)
  rol        String   @db.VarChar(30)
  is_active  Boolean  @default(true)
  created_at DateTime @default(now()) @map("created_at")

  employee_contacts employee_contacts[]
  payrolls          payrolls[]
  vehicles          vehicles[]

  @@map("employees")
}

model employee_contacts {
  id           Int      @id @default(autoincrement())
  employee_id  Int
  contact_info String   @unique @db.VarChar(100)
  created_at   DateTime @default(now()) @map("created_at")

  employees employees @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("employee_contacts")
}

// Todo de Vehiculos
model vehicle_types {
  id          Int      @id @default(autoincrement())
  type_name   String   @db.VarChar(20)
  description String   @db.VarChar(100)
  created_at  DateTime @default(now()) @map("created_at")

  vehicles vehicles[]

  @@map("vehicle_types")
}

model vehicles {
  id        Int @id @default(autoincrement())
  driver_id Int

  // Campo A√ëADIDO/REVISADO
  model String @db.VarChar(50) // Nuevo campo para el modelo comercial

  // Campo REVISADO (Matr√≠cula)
  license_plate String @unique @db.VarChar(10) // Placa (Matr√≠cula) - es √∫nico

  total_seats Int

  // Campo REVISADO (Tipo de Veh√≠culo - Llave For√°nea)
  vehicle_type_id Int

  // Campo REVISADO (Activo)
  is_active Boolean @default(true) // Estado (Activo o Inactivo)

  created_at DateTime @default(now()) @map("created_at")

  // Relaciones
  employees     employees     @relation(fields: [driver_id], references: [id], onDelete: Cascade)
  vehicle_types vehicle_types @relation(fields: [vehicle_type_id], references: [id], onDelete: Cascade)
  services      services[]
  repairs       repair[]

  @@map("vehicles")
}

model repair {
  // --- CAMPOS DE IDENTIFICACI√ìN Y TIEMPO ---
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  // --- CAMPOS DE RELACI√ìN ---
  vehicleId Int
  vehicle   vehicles @relation(fields: [vehicleId], references: [id])

  // --- CAMPOS ESPEC√çFICOS DE LA REPARACI√ìN ---
  description String    @db.Text // Descripci√≥n detallada de lo que se debe hacer o se hizo.
  status      String    @default("Pending") // Ej: Pending, InProgress, Completed, Canceled.
  startDate   DateTime?
  endDate     DateTime? // Fecha en que se complet√≥ la reparaci√≥n.

  // --- CAMPOS FINANCIEROS Y DE COSTO ---
  estimatedCost Float? // Costo estimado de las partes y mano de obra.
  finalCost     Float?

  @@map("repairs")
}

// Tabla de Clientes
model clients {
  id         Int      @id @default(autoincrement())
  rif        String   @unique @db.VarChar(20)
  name       String   @db.VarChar(30)
  contact    String   @unique @db.VarChar(20)
  address    String   @db.VarChar(100)
  created_at DateTime @default(now()) @map("created_at")

  services services[]

  @@map("clients")
}

// Todo de proveedores
model providers {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(30)
  rif        String   @db.VarChar(30)
  balance    Decimal  @db.Decimal(10, 2)
  is_active  Boolean  @default(true)
  created_at DateTime @default(now()) @map("created_at")

  provider_contacts provider_contacts[]
  provider_invoices provider_invoices[]

  @@map("providers")
}

model provider_contacts {
  id           Int      @id @default(autoincrement())
  provider_id  Int
  contact_info String   @unique @db.VarChar(100)
  created_at   DateTime @default(now()) @map("created_at")

  providers providers @relation(fields: [provider_id], references: [id], onDelete: Cascade)

  @@map("provider_contacts")
}

model provider_invoices {
  id             Int      @id @default(autoincrement())
  provider_id    Int
  control_number String   @db.VarChar(30)
  invoice_number String   @db.VarChar(30)
  invoice_date   DateTime
  total_amount   Decimal  @db.Decimal(10, 2)
  created_at     DateTime @default(now()) @map("created_at")

  // ‚úÖ relaci√≥n corregida
  provider          providers           @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  purchase_invoices purchase_invoices[]
  expenses          expenses[] // üîπ a√±ade esta relaci√≥n para vincular gastos autom√°ticos
}

model purchase_invoices {
  id                  Int      @id @default(autoincrement())
  provider_invoice_id Int
  expense_type_id     Int
  purchase_date       DateTime
  description         String   @db.Text
  exempt_amount       Decimal  @db.Decimal(10, 2)
  total_amount        Decimal  @db.Decimal(10, 2)
  created_at          DateTime @default(now()) @map("created_at")

  provider_invoices provider_invoices @relation(fields: [provider_invoice_id], references: [id], onDelete: Cascade)
  expense_types     expense_types     @relation(fields: [expense_type_id], references: [id], onDelete: Cascade)

  // üîπ Relaci√≥n inversa hacia retenciones de compras
  purchase_invoices_retentions purchase_invoices_retentions[]

  @@map("purchase_invoices")
}

// Todo de Servicios
model services {
  id         Int @id @default(autoincrement())
  vehicle_id Int
  client_id  Int

  // Fecha que se dio el servicio
  start_date DateTime
  end_date   DateTime

  // Factura
  invoice_number String   @unique @db.VarChar(30)
  invoice_date   DateTime @default(now())

  // Subtotal de servicio + estado de pago
  price          Decimal  @default(0) @db.Decimal(10, 2) // Subtotal de servicio sin rentenciones
  payment_status String   @default("pending") @db.VarChar(20) // Estado de pago: pending, paid, cancelled
  created_at     DateTime @default(now())

  vehicles vehicles @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)
  clients  clients  @relation(fields: [client_id], references: [id], onDelete: Cascade)

  services_retentions services_retentions[]

  @@index([vehicle_id])
  @@index([client_id])
  @@index([start_date, end_date])
  @@map("services")
}

model services_retentions {
  // Relaciones
  id             Int    @id @default(autoincrement())
  service_id     Int    @db.Integer
  code_retention String @db.VarChar(30)

  // Datos
  base_amount     Decimal  @db.Decimal(10, 2)
  rate_retention  Decimal  @db.Decimal(10, 2) // Tasa de retenci√≥n
  total_retention Decimal  @db.Decimal(10, 2) // Total de retenci√≥n
  created_at      DateTime @default(now())

  services   services   @relation(fields: [service_id], references: [id], onDelete: Cascade)
  retentions retentions @relation(fields: [code_retention], references: [code], onDelete: Cascade)

  @@map("services_retentions")
}

// Tabla de tipos de gastos
model expense_types {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(30)
  description String   @db.VarChar(100)
  created_at  DateTime @default(now()) @map("created_at")

  purchase_invoices purchase_invoices[]
  expense           expenses[]

  @@map("expense_types")
}

// Todo de gastos y ganancias
model expenses {
  id                  Int      @id @default(autoincrement())
  id_expense_type     Int
  provider_invoice_id Int? // üîπ relaci√≥n opcional con facturas de proveedores
  description         String   @db.VarChar(255)
  total               Decimal  @db.Decimal(10, 2)
  created_at          DateTime @default(now())

  expense_type     expense_types      @relation(fields: [id_expense_type], references: [id], onDelete: Cascade)
  provider_invoice provider_invoices? @relation(fields: [provider_invoice_id], references: [id], onDelete: Cascade)

  @@map("expenses")
}

model revenue {
  id          Int      @id @default(autoincrement())
  description String   @db.VarChar(255)
  amount      Decimal  @db.Decimal(10, 2) // total
  category    String   @default("servicio") @db.VarChar(100)
  date        DateTime // Fecha del revenue (no solo created_at)
  created_at  DateTime @default(now())

  @@index([date])
  @@index([category])
  @@map("revenue")
}

// Todo de nominas 
model payrolls {
  id          Int    @id @default(autoincrement())
  employee_id Int
  status      String @default("draft") @db.VarChar(30)

  period_start DateTime
  period_end   DateTime

  daily_salary    Decimal @db.Decimal(10, 2)
  total_days_paid Decimal @db.Decimal(10, 2)
  integral_salary Decimal @default(0) @db.Decimal(10, 2) // Salario integral 
  annual_earnings Decimal @default(0) @db.Decimal(10, 2) // Devengado anual
  monthly_salary  Decimal @db.Decimal(10, 2)
  assignments     Decimal @db.Decimal(10, 2) // Salario quincenal

  created_at DateTime @default(now())

  employee            employees             @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  payrolls_retentions payrolls_retentions[]

  @@map("payrolls")
}

model payrolls_retentions {
  id             Int    @id @default(autoincrement())
  payroll_id     Int
  retention_code String

  base_amount     Decimal @db.Decimal(10, 2) // monto de referencia
  rate_retention  Decimal @db.Decimal(10, 2) // Tasa de retenci√≥n
  total_retention Decimal @db.Decimal(10, 2) // Total de retenci√≥n

  created_at DateTime @default(now())

  payroll   payrolls   @relation(fields: [payroll_id], references: [id], onDelete: Cascade)
  retention retentions @relation(fields: [retention_code], references: [code], onDelete: Cascade)
}

model retentions {
  code        String   @id @db.VarChar(30)
  name        String   @db.VarChar(50)
  description String   @db.VarChar(100)
  created_at  DateTime @default(now())

  payrolls_retentions payrolls_retentions[]
  services_retentions services_retentions[]

  // üîπ Relaci√≥n inversa hacia retenciones de compras
  purchase_invoices_retentions purchase_invoices_retentions[]
}

model purchase_invoices_retentions {
  id                  Int    @id @default(autoincrement())
  purchase_invoice_id Int
  retention_code      String

  base_amount     Decimal  @db.Decimal(10, 2)
  rate_retention  Decimal  @db.Decimal(10, 2)
  total_retention Decimal  @db.Decimal(10, 2)
  created_at      DateTime @default(now())

  purchase_invoice purchase_invoices @relation(fields: [purchase_invoice_id], references: [id], onDelete: Cascade)
  retention        retentions        @relation(fields: [retention_code], references: [code], onDelete: Cascade)

  @@map("purchase_invoices_retentions")
}
